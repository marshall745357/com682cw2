<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>COM682 CW2 — Logic App CRUD</title>
    <style>
      :root {
        --bg: #0b0f19;
        --card: #111827;
        --card2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: rgba(255, 255, 255, 0.08);
        --accent: #60a5fa;
        --danger: #ef4444;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 24px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: #fd6f6f;
        color: var(--text);
      }

      .wrap {
        max-width: 980px;
        margin: 0 auto;
      }

      h1 {
        margin: 0 0 14px;
        font-size: 26px;
        letter-spacing: 0.2px;
      }

      p {
        margin: 8px 0 16px;
        color: var(--muted);
        line-height: 1.4;
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      .card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
      }

      .card h2 {
        margin: 0 0 10px;
        font-size: 18px;
      }

      .subtle {
        font-size: 12.5px;
        color: var(--muted);
        margin-top: 6px;
      }

      label {
        display: block;
        font-size: 12.5px;
        color: var(--muted);
        margin: 10px 0 6px;
      }

      input[type="text"],
      input[type="url"],
      textarea,
      select,
      input[type="file"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        outline: none;
        margin: 6px 0; /* wee margin */
      }

      textarea {
        min-height: 90px;
        resize: vertical;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 720px) {
        .row {
          grid-template-columns: 1fr;
        }
      }

      .btns {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }

      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        font-weight: 600;
      }

      button:hover {
        border-color: rgba(255, 255, 255, 0.18);
      }

      .primary {
        background: rgba(96, 165, 250, 0.18);
        border-color: rgba(96, 165, 250, 0.35);
      }

      .danger {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.35);
      }

      .out {
        background: #060a14;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        overflow: auto;
        max-height: 340px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        font-size: 12.5px;
        white-space: pre;
      }

      .note {
        font-size: 12px;
        color: var(--muted);
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>COM682 CW2 — Logic App CRUD</h1>
      <p>Paste your Logic App trigger URLs below, then use the buttons to test CRUD.</p>

      <div class="grid">
        <section class="card">
          <h2>Endpoint URLs</h2>
          <p class="note">Tip: Logic App HTTP triggers are usually POST. This page calls them with POST (even for “GET/DELETE” style endpoints).</p>

          <label for="urlCreate">Create (POST)</label>
          <input id="urlCreate" type="url" placeholder="Paste CREATE trigger URL" />

          <label for="urlList">List (get all) — POST trigger</label>
          <input id="urlList" type="url" placeholder="Paste LIST trigger URL" />

          <label for="urlGet">Get one (by id) — POST trigger</label>
          <input id="urlGet" type="url" placeholder="Paste GET-ONE trigger URL" />

          <label for="urlUpdate">Update (by id) — POST trigger</label>
          <input id="urlUpdate" type="url" placeholder="Paste UPDATE trigger URL" />

          <label for="urlDelete">Delete (by id) — POST trigger</label>
          <input id="urlDelete" type="url" placeholder="Paste DELETE trigger URL" />

          <div class="btns">
            <button id="saveUrls" class="primary">Save URLs (local)</button>
            <button id="loadUrls">Load URLs</button>
            <button id="clearUrls">Clear</button>
          </div>

          <p class="subtle">
            If a trigger URL already contains <code>&amp;id=</code>, remove it. This page appends <code>&amp;id=</code> itself when needed.
          </p>
        </section>

        <section class="card">
          <h2>Create / edit item</h2>

          <div class="row">
            <div>
              <label for="name">Name</label>
              <input id="name" type="text" placeholder="e.g. X32" />
            </div>

            <div>
              <label for="category">Category</label>
              <input id="category" type="text" placeholder="e.g. Mixer" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="manufacturer">Manufacturer</label>
              <input id="manufacturer" type="text" placeholder="e.g. Behringer" />
            </div>

            <div>
              <label for="file">File</label>
              <input id="file" type="file" />
            </div>
          </div>

          <label for="description">Description</label>
          <textarea id="description" placeholder="Description..."></textarea>

          <div class="btns">
            <button id="btnCreate" class="primary">Create</button>
          </div>
        </section>

        <section class="card">
          <h2>Read / Update / Delete</h2>

          <label for="itemId">Item ID</label>
          <input id="itemId" type="text" placeholder="Paste an item id (GUID) here" />

          <div class="btns">
            <button id="btnListAll">List All</button>
            <button id="btnGetOne">Get One</button>
            <button id="btnUpdate">Update (metadata)</button>
            <button id="btnDelete" class="danger">Delete</button>
          </div>
        </section>

        <section class="card">
          <h2>Output</h2>
          <div id="output" class="out">{}</div>
        </section>
      </div>
    </div>

    <script>
      const els = {
        urlCreate: document.getElementById("urlCreate"),
        urlList: document.getElementById("urlList"),
        urlGet: document.getElementById("urlGet"),
        urlUpdate: document.getElementById("urlUpdate"),
        urlDelete: document.getElementById("urlDelete"),

        name: document.getElementById("name"),
        category: document.getElementById("category"),
        manufacturer: document.getElementById("manufacturer"),
        description: document.getElementById("description"),
        file: document.getElementById("file"),
        itemId: document.getElementById("itemId"),

        output: document.getElementById("output"),

        saveUrls: document.getElementById("saveUrls"),
        loadUrls: document.getElementById("loadUrls"),
        clearUrls: document.getElementById("clearUrls"),

        btnCreate: document.getElementById("btnCreate"),
        btnListAll: document.getElementById("btnListAll"),
        btnGetOne: document.getElementById("btnGetOne"),
        btnUpdate: document.getElementById("btnUpdate"),
        btnDelete: document.getElementById("btnDelete"),
      };

      const STORAGE_KEY = "com682_cw2_logicapp_urls_v1";

      function safeJsonStringify(x) {
        try {
          return JSON.stringify(x, null, 2);
        } catch {
          return String(x);
        }
      }

      function setOutput(obj) {
        els.output.textContent = safeJsonStringify(obj);
      }

      function getUrls() {
        return {
          create: (els.urlCreate.value || "").trim(),
          list: (els.urlList.value || "").trim(),
          get: (els.urlGet.value || "").trim(),
          update: (els.urlUpdate.value || "").trim(),
          del: (els.urlDelete.value || "").trim(),
        };
      }

      function saveUrls() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(getUrls()));
        setOutput({ ok: true, saved: true });
      }

      function loadUrls() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return setOutput({ ok: false, message: "No saved URLs found." });
        const u = JSON.parse(raw);
        els.urlCreate.value = u.create || "";
        els.urlList.value = u.list || "";
        els.urlGet.value = u.get || "";
        els.urlUpdate.value = u.update || "";
        els.urlDelete.value = u.del || "";
        setOutput({ ok: true, loaded: true });
      }

      function clearUrls() {
        els.urlCreate.value = "";
        els.urlList.value = "";
        els.urlGet.value = "";
        els.urlUpdate.value = "";
        els.urlDelete.value = "";
        setOutput({ ok: true, cleared: true });
      }

      function withId(url, id) {
        const u = (url || "").trim();
        const clean = u.replace(/&id=[^&]*/g, "");
        if (!id) return clean;
        return clean + (clean.includes("?") ? "&" : "?") + "id=" + encodeURIComponent(id);
      }

      async function postJson(url, bodyObj) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyObj ?? {}),
        });

        const text = await res.text();
        let parsed;
        try {
          parsed = JSON.parse(text);
        } catch {
          parsed = text;
        }

        if (!res.ok) {
          throw { status: res.status, body: parsed };
        }
        return parsed;
      }

      async function postMultipart(url, fields, file) {
        const fd = new FormData();
        Object.entries(fields).forEach(([k, v]) => fd.append(k, v ?? ""));
        if (file) fd.append("file", file);

        const res = await fetch(url, { method: "POST", body: fd });
        const text = await res.text();
        let parsed;
        try {
          parsed = JSON.parse(text);
        } catch {
          parsed = text;
        }

        if (!res.ok) {
          throw { status: res.status, body: parsed };
        }
        return parsed;
      }

      function getFormMeta() {
        return {
          name: (els.name.value || "").trim(),
          category: (els.category.value || "").trim(),
          manufacturer: (els.manufacturer.value || "").trim(),
          description: (els.description.value || "").trim(),
        };
      }

      function copyIdIfPresent(payload) {
        // Accept a few common response shapes
        const id =
          payload?.id ||
          payload?.itemId ||
          payload?.body?.id ||
          payload?.body?.itemId ||
          null;

        if (id) els.itemId.value = id;
      }

      els.saveUrls.addEventListener("click", saveUrls);
      els.loadUrls.addEventListener("click", loadUrls);
      els.clearUrls.addEventListener("click", clearUrls);

      els.btnCreate.addEventListener("click", async () => {
        const { create } = getUrls();
        if (!create) return setOutput({ error: "Missing CREATE URL" });

        try {
          const meta = getFormMeta();
          const file = els.file.files?.[0] || null;
          const out = await postMultipart(create, meta, file);
          setOutput(out);
          copyIdIfPresent(out);
        } catch (e) {
          setOutput({ error: `HTTP ${e.status || "?"}`, details: e.body || e });
        }
      });

      els.btnListAll.addEventListener("click", async () => {
        const { list } = getUrls();
        if (!list) return setOutput({ error: "Missing LIST URL" });

        try {
          const out = await postJson(list, {});
          setOutput(out);
        } catch (e) {
          setOutput({ error: `HTTP ${e.status || "?"}`, details: e.body || e });
        }
      });

      els.btnGetOne.addEventListener("click", async () => {
        const { get } = getUrls();
        const id = (els.itemId.value || "").trim();
        if (!get) return setOutput({ error: "Missing GET-ONE URL" });
        if (!id) return setOutput({ error: "Missing Item ID" });

        try {
          const out = await postJson(withId(get, id), {});
          setOutput(out);
        } catch (e) {
          setOutput({ error: `HTTP ${e.status || "?"}`, details: e.body || e });
        }
      });

      els.btnUpdate.addEventListener("click", async () => {
        const { update } = getUrls();
        const id = (els.itemId.value || "").trim();
        if (!update) return setOutput({ error: "Missing UPDATE URL" });
        if (!id) return setOutput({ error: "Missing Item ID" });

        try {
          const meta = getFormMeta();
          const out = await postJson(withId(update, id), meta);
          setOutput(out);
        } catch (e) {
          setOutput({ error: `HTTP ${e.status || "?"}`, details: e.body || e });
        }
      });

      els.btnDelete.addEventListener("click", async () => {
        const { del } = getUrls();
        const id = (els.itemId.value || "").trim();
        if (!del) return setOutput({ error: "Missing DELETE URL" });
        if (!id) return setOutput({ error: "Missing Item ID" });

        try {
          const out = await postJson(withId(del, id), {});
          setOutput(out);
        } catch (e) {
          setOutput({ error: `HTTP ${e.status || "?"}`, details: e.body || e });
        }
      });

      // Auto-load saved URLs on open (if present)
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) loadUrls();
      } catch {}
    </script>
  </body>
</html>
